<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Budget Pro Cloud - Alvin Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { overflow: hidden; background: #000; font-family: 'Inter', sans-serif; color: #fff; }
        .viewport { width: 100vw; height: calc(100vh - 140px); overflow: hidden; position: relative; }
        .slider-container { display: flex; width: 300vw; height: 100%; transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .page { width: 100vw; height: 100%; overflow-y: auto; padding: 15px; box-sizing: border-box; }
        .glass-header { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .dark-card { background: #111; border: 1px solid #222; border-radius: 24px; transition: 0.3s; }
        .neon-input { background: #000; border: 1px solid #333; color: #fff; border-radius: 12px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; padding: 12px; }
        .calendar-day { text-align: center; padding: 8px 0; font-size: 11px; color: #555; border-radius: 12px; transition: 0.2s; cursor: pointer; position: relative; }
        .selected-day { background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6 !important; color: #fff !important; box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }
        .dot { width: 4px; height: 4px; border-radius: 50%; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); }
        .nav-active { color: #3b82f6 !important; filter: drop-shadow(0 0 5px #3b82f6); transform: translateY(-3px); }
        #monthPicker { border: none; background: transparent; color: #fff; font-weight: 800; cursor: pointer; }
        ::-webkit-calendar-picker-indicator { filter: invert(1); }
    </style>
</head>
<body>

    <header class="glass-header p-4 flex justify-between items-center z-50 sticky top-0">
        <div class="flex flex-col">
            <div class="flex items-center bg-white/5 px-3 py-1.5 rounded-xl border border-white/10">
                <i class="fas fa-calendar-alt text-blue-400 mr-2 text-sm"></i>
                <input type="month" id="monthPicker" onchange="changeMonth(this.value)">
            </div>
            <p class="text-[9px] text-gray-500 mt-1 ml-1 font-bold rangeLabel"></p>
        </div>
        <h1 class="text-[9px] font-black text-gray-700 tracking-widest uppercase">Alvin Cloud v11</h1>
    </header>

    <div class="viewport">
        <div class="slider-container" id="slider">
            
            <section class="page">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-black text-red-500">支出預算</h2>
                    <button onclick="resetDateFilter()" id="resetBtn1" class="hidden text-[9px] bg-red-500/10 text-red-400 px-2 py-1 rounded-md border border-red-500/20">重置過濾</button>
                </div>
                <div id="budgetCalendar" class="calendar-grid dark-card mb-4"></div>
                <div class="dark-card p-5 space-y-4 mb-6">
                    <input type="date" id="expDate" class="w-full neon-input p-3 text-sm">
                    <div class="flex gap-2">
                        <input type="text" id="expTitle" placeholder="支出項目" class="flex-1 neon-input p-3 text-sm">
                        <input type="number" id="expAmount" placeholder="金額" class="w-24 neon-input p-3 text-sm">
                    </div>
                    <button onclick="addData('expenses')" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold active:scale-95 transition shadow-lg shadow-red-900/20">新增紀錄</button>
                </div>
                <div id="expenseList" class="space-y-3 pb-20"></div>
            </section>

            <section class="page">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-black text-green-400">收入來源</h2>
                    <button onclick="resetDateFilter()" id="resetBtn2" class="hidden text-[9px] bg-green-500/10 text-green-400 px-2 py-1 rounded-md border border-green-500/20">重置過濾</button>
                </div>
                <div id="incomeCalendar" class="calendar-grid dark-card mb-4"></div>
                <div class="dark-card p-5 space-y-4 mb-6">
                    <input type="date" id="incDate" class="w-full neon-input p-3 text-sm">
                    <div class="flex gap-2">
                        <input type="text" id="incTitle" placeholder="來源說明" class="flex-1 neon-input p-3 text-sm">
                        <input type="number" id="incAmount" placeholder="金額" class="w-24 neon-input p-3 text-sm">
                    </div>
                    <button onclick="addData('incomes')" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold active:scale-95 transition shadow-lg shadow-green-900/20">新增收入</button>
                </div>
                <div id="incomeList" class="space-y-3 pb-20"></div>
            </section>

            <section class="page">
                <h2 class="text-xl font-black mb-6 text-blue-400">帳期數據匯整</h2>
                <div class="dark-card p-8 flex flex-col items-center mb-6">
                    <div style="width: 180px; height: 180px;"><canvas id="budgetChart"></canvas></div>
                    <div class="mt-6 text-center">
                        <p class="text-gray-500 text-[10px] mb-1 font-bold uppercase tracking-widest">本期預估結餘</p>
                        <p id="balanceText" class="text-3xl font-black text-white">$0</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="dark-card p-5 border-l-2 border-green-500/50">
                        <p class="text-[9px] text-green-400 font-bold mb-1">TOTAL INCOME</p>
                        <p id="totalIncText" class="text-xl font-black">$0</p>
                    </div>
                    <div class="dark-card p-5 border-l-2 border-red-500/50">
                        <p class="text-[9px] text-red-400 font-bold mb-1">TOTAL EXPENSE</p>
                        <p id="totalExpText" class="text-xl font-black">$0</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-black/90 backdrop-blur-xl border-t border-white/5 h-[75px] flex justify-around items-center z-50">
        <button onclick="goToPage(0)" class="nav-btn nav-active flex flex-col items-center text-gray-600"><i class="fas fa-wallet text-xl"></i><span class="text-[10px] mt-1 font-bold">支出</span></button>
        <button onclick="goToPage(1)" class="nav-btn flex flex-col items-center text-gray-600"><i class="fas fa-hand-holding-usd text-xl"></i><span class="text-[10px] mt-1 font-bold">收入</span></button>
        <button onclick="goToPage(2)" class="nav-btn flex flex-col items-center text-gray-600"><i class="fas fa-chart-pie text-xl"></i><span class="text-[10px] mt-1 font-bold">分析</span></button>
    </nav>

    <script>
        // --- 請在此填入你的 Supabase 資訊 ---
        const SB_URL = "https://apwiglemrzpamtltcrzp.supabase.co";
        const SB_KEY = "sb_publishable_0mLcvlpjNoquYLhEUO54OA_8pSn5m7R";
        const supabase = bootstrapSupabase();

        function bootstrapSupabase() {
            return supabase.createClient(SB_URL, SB_KEY);
        }

        let db_local = { incomes: [], expenses: [] };
        let chart = null;
        const REFRESH_DAY = 5; 
        let selectedDate = null;
        
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];

        // 核心週期邏輯：判定日期屬於哪個帳期
        function getPeriod(dateStr) {
            const d = new Date(dateStr);
            let y = d.getFullYear(), m = d.getMonth() + 1;
            if (d.getDate() < REFRESH_DAY) { m--; if (m === 0) { m = 12; y--; } }
            return `${y}-${String(m).padStart(2, '0')}`;
        }

        let viewingMonth = getPeriod(todayStr);

        async function fetchAll() {
            const { data: exp } = await supabase.from('expenses').select('*');
            const { data: inc } = await supabase.from('incomes').select('*');
            db_local.expenses = exp || [];
            db_local.incomes = inc || [];
            renderAll();
        }

        async function addData(table) {
            const prefix = table === 'incomes' ? 'inc' : 'exp';
            const payload = {
                date: document.getElementById(prefix+'Date').value,
                title: document.getElementById(prefix+'Title').value,
                amount: parseFloat(document.getElementById(prefix+'Amount').value) || 0
            };
            if (!payload.date || !payload.title || payload.amount <= 0) return alert("填寫不完整");
            
            await supabase.from(table).insert([payload]);
            document.getElementById(prefix+'Title').value = '';
            document.getElementById(prefix+'Amount').value = '';
            fetchAll();
        }

        async function deleteData(id, table) {
            if (!confirm("確定刪除？")) return;
            await supabase.from(table).delete().eq('id', id);
            fetchAll();
        }

        function renderAll() {
            document.getElementById('monthPicker').value = viewingMonth;
            const [y, m] = viewingMonth.split('-').map(Number);
            const rangeStr = `${y}/${m}/5 ~ ${m===12?y+1:y}/${m===12?1:m+1}/4`;
            document.querySelectorAll('.rangeLabel').forEach(el => el.innerText = rangeStr);
            
            document.getElementById('resetBtn1').classList.toggle('hidden', !selectedDate);
            document.getElementById('resetBtn2').classList.toggle('hidden', !selectedDate);

            // 1. 日曆與點擊過濾邏輯
            const drawCal = (id, items, color) => {
                const el = document.getElementById(id); el.innerHTML = '';
                for (let i = 1; i <= 31; i++) {
                    const dStr = `${y}-${String(m).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const hasData = items.some(item => item.date === dStr && getPeriod(item.date) === viewingMonth);
                    el.innerHTML += `
                        <div class="calendar-day ${selectedDate===dStr?'selected-day':''}" 
                             onclick="selectedDate=(selectedDate==='${dStr}')?null:'${dStr}';renderAll()">
                            ${i}${hasData?`<div class="dot" style="background:${color}"></div>`:''}
                        </div>`;
                }
            };
            drawCal('budgetCalendar', db_local.expenses, '#ef4444');
            drawCal('incomeCalendar', db_local.incomes, '#22c55e');

            // 2. 列表篩選
            const drawList = (id, items, table, color) => {
                const el = document.getElementById(id); el.innerHTML = '';
                let filtered = items.filter(i => getPeriod(i.date) === viewingMonth);
                if (selectedDate) filtered = filtered.filter(i => i.date === selectedDate);

                if (filtered.length === 0) { el.innerHTML = `<p class="text-center text-gray-700 text-[10px] mt-10">NO RECORDS FOUND</p>`; return; }

                filtered.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(item => {
                    el.innerHTML += `
                        <div class="dark-card p-4 border-l-2 border-${color}-500/50 mb-3" onclick="this.querySelector('.del').classList.toggle('hidden')">
                            <div class="flex justify-between items-center"><span class="text-[9px] text-gray-500 font-bold">${item.date}</span><span class="font-black">$${item.amount.toLocaleString()}</span></div>
                            <div class="text-sm text-gray-400 font-medium">${item.title}</div>
                            <div class="del hidden pt-3 mt-3 border-t border-white/5"><button onclick="deleteData(${item.id}, '${table}')" class="text-[9px] text-red-500 bg-red-950/20 px-3 py-1.5 rounded-lg border border-red-500/20">DELETE</button></div>
                        </div>`;
                });
            };
            drawList('expenseList', db_local.expenses, 'expenses', 'red');
            drawList('incomeList', db_local.incomes, 'incomes', 'green');
            updateSummary();
        }

        function updateSummary() {
            const mExp = db_local.expenses.filter(i => getPeriod(i.date) === viewingMonth).reduce((s,i)=>s+i.amount, 0);
            const mInc = db_local.incomes.filter(i => getPeriod(i.date) === viewingMonth).reduce((s,i)=>s+i.amount, 0);
            document.getElementById('totalExpText').innerText = `$${mExp.toLocaleString()}`;
            document.getElementById('totalIncText').innerText = `$${mInc.toLocaleString()}`;
            document.getElementById('balanceText').innerText = `$${(mInc-mExp).toLocaleString()}`;
            
            const ctx = document.getElementById('budgetChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: [mExp||0.1, mInc||0.1], backgroundColor: ['#b91c1c', '#15803d'], borderWidth: 0 }] }, options: { cutout: '88%' } });
        }

        function goToPage(idx) {
            document.getElementById('slider').style.transform = `translateX(-${idx * 100}vw)`;
            document.querySelectorAll('.nav-btn').forEach((btn, i) => btn.classList.toggle('nav-active', i === idx));
        }

        function changeMonth(val) { viewingMonth = val; selectedDate = null; renderAll(); }
        function resetDateFilter() { selectedDate = null; renderAll(); }

        // 初始載入與預填
        document.getElementById('expDate').value = todayStr;
        document.getElementById('incDate').value = todayStr;
        fetchAll();
    </script>
</body>
</html>
