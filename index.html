<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Budget Pro v10 - Interactive Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { overflow: hidden; background: #000000; font-family: 'Inter', sans-serif; color: #ffffff; }
        .viewport { width: 100vw; height: calc(100vh - 130px); overflow: hidden; position: relative; }
        .slider-container { display: flex; width: 300vw; height: 100%; transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .page { width: 100vw; height: 100%; overflow-y: auto; padding: 15px; box-sizing: border-box; }
        
        .glass-header { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(15px); }
        .dark-card { background: #111111; border: 1px solid #222; border-radius: 24px; }
        .neon-input { background: #000; border: 1px solid #333; color: #fff; border-radius: 12px; }
        
        /* 日曆與點擊樣式 */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; padding: 10px; }
        .calendar-day { 
            text-align: center; padding: 10px 0; font-size: 11px; color: #555; border-radius: 12px;
            transition: all 0.2s; cursor: pointer; position: relative; border: 1px solid transparent;
        }
        .calendar-day:active { transform: scale(0.9); }
        .has-data { color: #bbb; }
        
        /* 選中日期的霓虹效果 */
        .selected-day { 
            background: rgba(59, 130, 246, 0.2); 
            border-color: #3b82f6 !important; 
            color: #fff !important; 
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        .dot { width: 4px; height: 4px; border-radius: 50%; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); }
        .nav-active { color: #3b82f6 !important; filter: drop-shadow(0 0 5px #3b82f6); transform: translateY(-3px); }
        #monthPicker { border: none; background: transparent; color: #fff; font-weight: 800; }
        ::-webkit-calendar-picker-indicator { filter: invert(1); }
    </style>
</head>
<body>

    <header class="glass-header p-4 shadow-xl flex justify-between items-center z-50 sticky top-0 border-b border-white/5">
        <div class="flex items-center bg-white/5 px-3 py-1.5 rounded-xl border border-white/10">
            <i class="fas fa-calendar-alt text-blue-400 mr-2 text-sm"></i>
            <input type="month" id="monthPicker" onchange="changeMonth(this.value)">
        </div>
        <div class="text-right">
            <h1 class="text-[9px] font-black text-gray-600 tracking-widest uppercase">Select Mode</h1>
        </div>
    </header>

    <div class="viewport">
        <div class="slider-container" id="slider">
            
            <section class="page">
                <div class="flex justify-between items-center mb-2 px-1">
                    <h2 class="text-lg font-black text-red-500">支出預算</h2>
                    <span class="text-[9px] text-gray-500 rangeLabel"></span>
                </div>
                <div id="budgetCalendar" class="calendar-grid dark-card mb-4"></div>
                
                <div id="expInputArea" class="dark-card p-5 space-y-4 mb-6">
                    <input type="date" id="expDate" class="w-full neon-input p-3 text-sm">
                    <div class="flex gap-2">
                        <input type="text" id="expTitle" placeholder="項目內容" class="flex-1 neon-input p-3 text-sm">
                        <input type="number" id="expAmount" placeholder="金額" class="w-24 neon-input p-3 text-sm">
                    </div>
                    <button onclick="addData('expense')" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold active:scale-95 transition shadow-lg shadow-red-900/20">紀錄項目</button>
                </div>

                <div class="flex items-center justify-between mb-3 px-2">
                    <span class="text-[10px] font-bold text-gray-400 tracking-tighter uppercase filter-status">ALL RECORDS</span>
                    <button onclick="clearFilter()" id="clearBtn" class="hidden text-[9px] bg-blue-500/20 text-blue-400 px-2 py-1 rounded-md border border-blue-500/30">重置過濾</button>
                </div>
                <div id="expenseList" class="space-y-3 pb-20"></div>
            </section>

            <section class="page">
                <div class="flex justify-between items-center mb-2 px-1">
                    <h2 class="text-lg font-black text-green-400">收入來源</h2>
                    <span class="text-[9px] text-gray-500 rangeLabel"></span>
                </div>
                <div id="incomeCalendar" class="calendar-grid dark-card mb-4"></div>
                <div class="dark-card p-5 space-y-4 mb-6">
                    <input type="date" id="incDate" class="w-full neon-input p-3 text-sm">
                    <div class="flex gap-2">
                        <input type="text" id="incTitle" placeholder="來源說明" class="flex-1 neon-input p-3 text-sm">
                        <input type="number" id="incAmount" placeholder="金額" class="w-24 neon-input p-3 text-sm">
                    </div>
                    <button onclick="addData('income')" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold active:scale-95 transition shadow-lg shadow-green-900/20">紀錄收入</button>
                </div>
                <div class="flex items-center justify-between mb-3 px-2">
                    <span class="text-[10px] font-bold text-gray-400 tracking-tighter uppercase filter-status">ALL RECORDS</span>
                </div>
                <div id="incomeList" class="space-y-3 pb-20"></div>
            </section>

            <section class="page">
                <h2 class="text-xl font-black mb-6 text-blue-400 ml-1">帳期匯整</h2>
                <div class="dark-card p-8 flex flex-col items-center mb-6">
                    <div style="width: 180px; height: 180px;"><canvas id="budgetChart"></canvas></div>
                    <div class="mt-6 text-center">
                        <p class="text-gray-500 text-[10px] mb-1 font-bold uppercase tracking-widest"><span class="viewingLabel"></span> 剩餘結餘</p>
                        <p id="balanceText" class="text-4xl font-black text-white">$0</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="dark-card p-5 border-l-4 border-green-500/50">
                        <p class="text-[9px] text-green-400 font-bold uppercase mb-1">Total Income</p>
                        <p id="totalIncText" class="text-xl font-black text-white">$0</p>
                    </div>
                    <div class="dark-card p-5 border-l-4 border-red-500/50">
                        <p class="text-[9px] text-red-400 font-bold uppercase mb-1">Total Expense</p>
                        <p id="totalExpText" class="text-xl font-black text-white">$0</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-black/90 backdrop-blur-xl border-t border-white/5 h-[75px] flex justify-around items-center z-50">
        <button onclick="goToPage(0)" class="nav-btn nav-active flex flex-col items-center text-gray-600"><i class="fas fa-wallet text-xl"></i><span class="text-[10px] mt-1 font-bold">支出</span></button>
        <button onclick="goToPage(1)" class="nav-btn flex flex-col items-center text-gray-600"><i class="fas fa-hand-holding-usd text-xl"></i><span class="text-[10px] mt-1 font-bold">收入</span></button>
        <button onclick="goToPage(2)" class="nav-btn flex flex-col items-center text-gray-600"><i class="fas fa-chart-pie text-xl"></i><span class="text-[10px] mt-1 font-bold">匯整</span></button>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('budgetV10')) || { incomes: [], expenses: [] };
        let chart = null;
        const REFRESH_DAY = 5; 
        let selectedDate = null; // 全域選取日期狀態

        function getPeriod(dateStr) {
            const d = new Date(dateStr);
            let y = d.getFullYear(), m = d.getMonth() + 1;
            if (d.getDate() < REFRESH_DAY) { m--; if (m === 0) { m = 12; y--; } }
            return `${y}-${String(m).padStart(2, '0')}`;
        }

        const now = new Date();
        let viewingMonth = getPeriod(now);
        document.getElementById('monthPicker').value = viewingMonth;
        document.getElementById('expDate').value = now.toISOString().split('T')[0];
        document.getElementById('incDate').value = now.toISOString().split('T')[0];

        function changeMonth(val) { viewingMonth = val; selectedDate = null; renderAll(); }

        function clearFilter() { selectedDate = null; renderAll(); }

        function toggleDate(dateStr) {
            if (selectedDate === dateStr) {
                selectedDate = null; // 點第二次取消
            } else {
                selectedDate = dateStr; // 選中日期
            }
            renderAll();
        }

        function goToPage(idx) {
            document.getElementById('slider').style.transform = `translateX(-${idx * 100}vw)`;
            document.querySelectorAll('.nav-btn').forEach((btn, i) => btn.classList.toggle('nav-active', i === idx));
            if (idx === 2) updateSummary();
        }

        function addData(type) {
            const prefix = type === 'income' ? 'inc' : 'exp';
            const data = { id: Date.now(), date: document.getElementById(prefix+'Date').value, title: document.getElementById(prefix+'Title').value, amount: parseFloat(document.getElementById(prefix+'Amount').value) || 0 };
            if (!data.date || !data.title || data.amount <= 0) return alert("填寫錯誤");
            type === 'income' ? db.incomes.push(data) : db.expenses.push(data);
            localStorage.setItem('budgetV10', JSON.stringify(db));
            document.getElementById(prefix+'Title').value = '';
            document.getElementById(prefix+'Amount').value = '';
            renderAll();
        }

        function deleteData(id, type) {
            if (!confirm("確定刪除此紀錄？")) return;
            type === 'income' ? db.incomes = db.incomes.filter(i => i.id !== id) : db.expenses = db.expenses.filter(i => i.id !== id);
            localStorage.setItem('budgetV10', JSON.stringify(db));
            renderAll();
        }

        function renderAll() {
            document.querySelectorAll('.viewingLabel').forEach(el => el.innerText = viewingMonth);
            const [y, m] = viewingMonth.split('-').map(Number);
            const rangeStr = `${y}/${m}/5 ~ ${m === 12 ? y+1 : y}/${m === 12 ? 1 : m+1}/4`;
            document.querySelectorAll('.rangeLabel').forEach(el => el.innerText = rangeStr);

            // 更新過濾文字與重置按鈕
            document.querySelectorAll('.filter-status').forEach(el => el.innerText = selectedDate ? `Viewing: ${selectedDate}` : "All Records");
            document.getElementById('clearBtn').classList.toggle('hidden', !selectedDate);

            // 1. 月曆渲染
            const drawCal = (id, items, color) => {
                const el = document.getElementById(id); el.innerHTML = '';
                // 這裡渲染整個帳期可能橫跨的月份天數
                for (let i = 1; i <= 31; i++) {
                    const dStr = `${y}-${String(m).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const hasData = items.some(item => item.date === dStr && getPeriod(item.date) === viewingMonth);
                    const isSelected = selectedDate === dStr;
                    
                    el.innerHTML += `
                        <div class="calendar-day ${hasData ? 'has-data':''} ${isSelected ? 'selected-day':''}" 
                             onclick="toggleDate('${dStr}')">
                            ${i}
                            ${hasData ? `<div class="dot" style="background:${color}"></div>`:''}
                        </div>`;
                }
            };
            drawCal('budgetCalendar', db.expenses, '#ef4444');
            drawCal('incomeCalendar', db.incomes, '#22c55e');

            // 2. 列表過濾邏輯
            const drawList = (id, items, type, color) => {
                const el = document.getElementById(id); el.innerHTML = '';
                // 核心過濾：必須符合帳期，且如果選了日期，必須符合日期
                let filtered = items.filter(i => getPeriod(i.date) === viewingMonth);
                if (selectedDate) {
                    filtered = filtered.filter(i => i.date === selectedDate);
                }

                if (filtered.length === 0) { 
                    el.innerHTML = `<p class="text-center text-gray-700 text-[10px] mt-10">NO DATA FOUND</p>`; 
                    return; 
                }

                filtered.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(item => {
                    el.innerHTML += `
                        <div class="dark-card p-4 border-l-2 border-${color}-500/50" onclick="this.querySelector('.detail-content').classList.toggle('active')">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[9px] font-bold text-gray-500 uppercase">${item.date}</span>
                                <span class="font-black text-white text-lg">$${item.amount.toLocaleString()}</span>
                            </div>
                            <div class="text-gray-400 font-medium text-sm">${item.title}</div>
                            <div class="detail-content">
                                <button onclick="event.stopPropagation(); deleteData(${item.id}, '${type}')" class="text-[10px] text-red-400 font-bold bg-red-950/30 px-3 py-2 rounded-lg mt-2">DELETE</button>
                            </div>
                        </div>`;
                });
            };
            drawList('expenseList', db.expenses, 'expense', 'red');
            drawList('incomeList', db.incomes, 'income', 'green');
            
            updateSummary();
        }

        function updateSummary() {
            // 匯整頁始終顯示整個帳期的數據，不受單日過濾影響
            const mExp = db.expenses.filter(i => getPeriod(i.date) === viewingMonth).reduce((s,i)=>s+i.amount, 0);
            const mInc = db.incomes.filter(i => getPeriod(i.date) === viewingMonth).reduce((s,i)=>s+i.amount, 0);
            document.getElementById('totalExpText').innerText = `$${mExp.toLocaleString()}`;
            document.getElementById('totalIncText').innerText = `$${mInc.toLocaleString()}`;
            document.getElementById('balanceText').innerText = `$${(mInc-mExp).toLocaleString()}`;
            const ctx = document.getElementById('budgetChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: [mExp || 0.1, mInc || 0.1], backgroundColor: ['#b91c1c', '#15803d'], borderWidth: 0 }] }, options: { cutout: '88%', events: [] } });
        }
        renderAll();
    </script>
</body>
</html>